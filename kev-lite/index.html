<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEV Lite</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    
    <!-- Custom CSS for table styling -->
    <style>
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: #f0f8ff;
            /* Light Blue */
        }
    </style>
    
    <style>
        /* Smaller font size for table cells */
        .table-sm td,
        .table-sm th {
            font-size: 0.8rem;
            /* Adjust the font size as needed */
        }
        
        /* Limit the width of the "Vulnerability Name" field to 33% */
        .table-sm .vulnerability-name-cell {
            max-width: 33%;
            word-wrap: break-word;
            /* Enable word wrapping */
        }
    </style>
</head>

<body>
    <div class="container mt-4">
        <h1 class="mb-4">KEV Lite </h1>
        <p>A low-calorie view of the current KEV list. Unofficial, not fit for any purpose, etc.</p>
        <p>Complaints and requests will be efficiently ignored when sent to <a href="https://infosec.exchange/@todb/">Tod</a>.</p>
        <p>
            <ul>
                <li><a href="https://cisa.gov/kev">Real KEV</a></li>
                <li><a href="https://www.cisa.gov/news-events/directives/bod-22-01-reducing-significant-risk-known-exploited-vulnerabilities">BOD 22-01</a> background and FAQ</li>
            </ul>
        </p>
        <div id="data-container"></div>
        
        <!-- Bootstrap JS and Popper.js (required for some Bootstrap components) -->
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
        
        <!-- Your JavaScript code -->
        <script>
            // Fetch JSON data from the provided URL
            fetch('http://localhost:8000/cisa.json')
            .then(response => response.json())
            .then(data => {
                // Sort vulnerabilities by dateAdded (latest first)
                data.vulnerabilities.sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));
                // Assign the fetched data to the jsonData variable
                const jsonData = data;
                // Call the renderData function to display the sorted data on the page
                renderData(jsonData);
            })
            .catch(error => console.error('Error fetching data:', error));
            
            function renderData(data) {
                const container = document.getElementById('data-container');
                
                // Iterate through vulnerabilities and update notes with clickable links
                data.vulnerabilities.forEach(vulnerability => {
                    vulnerability.notes = vulnerability.notes.replace(/(https?:\/\/[^\s,]+)([\s,]*)/g, (match, cap1, cap2) => {
                        return `<a href="${cap1}" target="_blank">${cap1}</a>${cap2}`;
                    });
                });
                
                // Display catalog information
                container.innerHTML += `<h2>Catalog Version: ${data.catalogVersion}</h2>`;
                container.innerHTML += `<p>Date Released: ${data.dateReleased}</p>`;
                container.innerHTML += `<p>Total Number of Known Exploited Vulnerabilities: ${data.count}</p>`;
                
                // Create a table with Bootstrap's table-striped class
                container.innerHTML += `
                <table class="table table-sm table-striped mt-3">
                    <thead>
                        <tr>
                            <th class="text-nowrap">CVE ID</th>
                            <th class="vulnerability-name-cell">Vulnerability Name</th>
                            <th>Date Added</th>
                            <th>Due Date</th>
                        </tr>
                    </thead>
                    <tbody id="vulnerability-table-body">
                    </tbody>
                </table>
                `;
                
                const tableBody = document.getElementById('vulnerability-table-body');
                
                // Display each vulnerability in the table
                data.vulnerabilities.forEach(vulnerability => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td class="text-nowrap"><a href="#details-${vulnerability.cveID}">${vulnerability.cveID}</a></td>
                    <td class="vulnerability-name-cell">${vulnerability.vulnerabilityName}</td>
                    <td class="text-nowrap">${vulnerability.dateAdded}</td>
                    <td class="text-nowrap">${vulnerability.dueDate}</td>
                    `;
                    
                    // Add a data attribute to store additional information
                    row.setAttribute('data-toggle', 'collapse');
                    row.setAttribute('data-target', `#details-${vulnerability.cveID}`);
                    row.setAttribute('aria-controls', `details-${vulnerability.cveID}`);
                    row.classList.add('clickable-row');
                    
                    tableBody.appendChild(row);
                    
                    // Create a collapsible row for additional details
                    const detailsRow = document.createElement('tr');
                    detailsRow.innerHTML = `
                    <td colspan="4" class="p-0">
                        <div class="collapse" id="details-${vulnerability.cveID}">
                            <div class="card card-body">
                                <p><strong>Description:</strong> ${vulnerability.shortDescription}</p>
                                <p><strong>Action:</strong> ${vulnerability.requiredAction}</p>
                                ${vulnerability.notes ? `<p><strong>Notes and Links:</strong> ${vulnerability.notes}</p>` : ''}
                                ${vulnerability.knownRansomwareCampaignUse === 'Known' ? '<p><em>Note, this vulnerability has been used in at least one ransomware campaign.</em></p>' : ''}
                            </div>
                        </div>
                    </td>
                    `;
                    
                    tableBody.appendChild(detailsRow);
                });
                
                // Add click event listener to toggle collapse
                const clickableRows = document.querySelectorAll('.clickable-row');
                clickableRows.forEach(row => {
                    row.addEventListener('click', () => {
                        const targetId = row.getAttribute('data-target');
                        const target = document.querySelector(targetId);
                        $(target).collapse('toggle');
                    });
                });
            }
            
        </script>
        
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const hash = window.location.hash;
                console.log('Here is the hash: ' + hash);
                if (hash && typeof $ !== 'undefined' && typeof $.fn.collapse !== 'undefined') {
                    setTimeout(function () {
                        const target = document.querySelector(hash);
                        console.log('Here is the target: ' + target);
                        if (target) {
                            $(target).collapse('show');
                            // Scroll to the target and align it comfortably.
                            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            window.scrollBy(0, -50);                    }
                        }, 500);
                    }
                });
                
                // Add click event listener to toggle collapse
                const clickableRows = document.querySelectorAll('.clickable-row');
                clickableRows.forEach(row => {
                    row.addEventListener('click', () => {
                        const targetId = row.getAttribute('data-target');
                        const target = document.querySelector(targetId);
                        if (typeof $ !== 'undefined' && typeof $.fn.collapse !== 'undefined') {
                            $(target).collapse('toggle');
                        }
                    });
                });
            </script>
        </div>
    </body>
    
    </html>